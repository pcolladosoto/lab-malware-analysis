# Makefile for handling the compilation of ASM programs.

ASSEMBLER = nasm
LINKER = gcc

O_FORMAT = elf64

CFLAGS = -no-pie
AFLAGS = -g

FNAMES = simple_adder
SRCS = $(addsuffix .asm, $(FNAMES))
PROGS = $(addsuffix .ex, $(FNAMES))

TRASH = *.o *.ex

# Detect the current Kernel to adjust the output format
# Check possible formats with 'nasm -hf'
ifeq ($(OS), WINDOWS_NT)
$(error Cannot compile on Windows)
else
k_type = $(shell uname -s)

ifeq ($(k_type), Darwin)
O_FORMAT = macho64
endif

endif

all: $(PROGS)
	$(info Compiled for the $(k_type) kernel with the $(O_FORMAT) format)

%.ex: %.o
	$(LINKER) -o $@ $< $(CFLAGS)

%.o: %.asm
	$(ASSEMBLER) $(AFLAGS) -f $(O_FORMAT) -o $@ $<

.PHONY: clean respect_specs clean_fixed

clean: clean_fixed
	rm -f $(TRASH)

respect_specs:
	./tidy_up.sh $(SRCS)

clean_fixed:
	rm -f $(shell ls *_fixed.asm 2> /dev/null)
