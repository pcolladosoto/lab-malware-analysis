# Makefile for handling the compilation of ASM programs.

ASSEMBLER = nasm
LINKER = gcc

O_FORMAT = elf64

CFLAGS = -no-pie
AFLAGS = -g

FNAMES = hello_world print_data print_data_short
SRCS = $(addsuffix .asm, $(FNAMES))
PROGS = $(addsuffix .ex, $(FNAMES))

TRASH = *.o *.ex

# Detect the current Kernel to adjust the output format
# Check possible formats with 'nasm -hf'
ifeq ($(OS), WINDOWS_NT)
$(error Cannot compile on Windows)
else
k_type = $(shell uname -s)

ifeq ($(k_type), Darwin)
O_FORMAT = macho64
endif

$(info Compiling for the $(k_type) kernel with the $(O_FORMAT) format)
endif

all: $(PROGS)

hello_world.ex: hello_world.o
	$(LINKER) -o $@ $< $(CFLAGS)

print_data.ex: print_data.o
	$(LINKER) -o $@ $< $(CFLAGS)

print_data_short.ex: print_data_short.o
	$(LINKER) -o $@ $< $(CFLAGS)

%.o: %.asm
	$(ASSEMBLER) $(AFLAGS) -f $(O_FORMAT) -o $@ $<

.PHONY: clean respect_specs

clean:
	rm -f $(TRASH)

respect_specs:
	$(foreach file, $(SRCS), ./tidy_up.sh $(file))
